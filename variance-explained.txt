
Analysis Plan for Variance Explained Analysis – v4.1

Analysis queries should be directed via email to: laura.corbin@bristol.ac.uk

Requirements:
1)	1000genomes (or HRC) imputed genotype data in: .bgen, .gen or .vcf.gz format
2)	Phenotype data on: fasting glucose, fasting insulin, HbA1c and/or 2-hour glucose 
3)	qctool v2
4)	DosageConverter (only if genotype data in .vcf format)
5)	PLINK v1.90b4.1 64-bit (30 Mar 2017) or more recent (not Plink2 as the way this handles dosage files is different)
6)	R v3.3.3 or similar

In the instructions that follow, I will assume European ancestry (EA). If your cohort is not of this ancestry, simply replace ‘EA’ in files names with the appropriate ancestry identifier (EAA, IAA, HA, UAA).

Files provided:
Each analyst will receive a SNP list for their ancestry containing all the SNPs that represent signals across any of the phenotypes analysed in the meta-analysis. There are two formats for these SNP lists: EA_all_MarkerName_round2.txt /. EA_all_rsid_round2.txt. Both these files contain the same variants but the former use the SNP ID generated by MAGIC during QC (chr:pos:markertype) and the latter use rsIDs – use whichever matches the format of IDs in your data. For VCFs, the SNP ID is chr:pos form and so you will need to edit this file to remove the “:SNP” part (see below).

In addition, analysts will receive three genetic risk score (GRS) variant files with corresponding (ancestry specific) betas for each phenotype they have in their cohort. The file names will end in either ‘_adjBetas’, if data from your cohort was included in the GWAS analysis , or, ‘_unadjBetas.txt’ if data from your cohort was not included in the GWAS analysis.  There will be three GRS variant files per trait and ancestry, for example, EAonly_cohort_FGluadjBMI_adjBetas.txt (EA signals only), EAplusTE_cohort_FGluadjBMI_adjBetas.txt (EA signals plus trans-ethnic signals) and completeTEplusEA_cohort_GluadjBMI_adjBetas.txt (all signals from the MANTRA analysis plus EA signals).  

 
Analysis:

1)	Extract dosages in plink compatible format
There are two slightly different work flows depending on the starting genotype file format. If you have .bgen (or .gen) format, please follow (A); if you have .vcf.gz format, please follow (B).

(A)	Use the qctool v2 command ‘--incl-rsids’ to generate a single .gen file containing the SNPs listed in the SNP list file for the relevant ancestry, e.g. EA_all_rsid_round2.txt / EA_all_MarkerName_round2.txt.  To convert the data to .gen format, use an output file name ending in .gen after the ‘--og’ option.

Use the qctool v2 commands ‘--snp-stats’ and ‘--sample-stats’ to compute SNP summaries (for all SNPs in the SNP list file) and sample summaries (for the same individuals included in the variance explained computation); direct the output to EA_cohortname_snp_stats.txt & EA_cohortname_sample_stats.txt, respectively. Please return these files along with results from the variance explained analysis (see below).

Finally, use the qctool v2 command ‘--ofiletype dosage’ to convert the data to dosage format.  Please note the code below is an example and the exact commands may vary depending on the exact format of your .bgen files (e.g. whether you need the -omit-chromosome option). Please check that the dosage file created looks as expected.

Example shell script using qctool:

# shell script to extract snp list from genotype files, generate summaries and make dosage files for plink 

# specify input/output file paths
snplistfile=input/EA_all_rsid_round2.txt 
genfile=bgenfiles/data_chrCHR.bgen [or] genfile=bgenfiles/data_chrCHR.vcf
outfile=output/EA_snps


# loop round files for different chromosomes and extract SNPs
for i in {01..23}
do
	filename=$(sed -e "s/CHR/$i/g" <<< ${genfile})
	echo ""
	echo "$filename"
	echo "${outfile}_${i}"
	echo ""
	qctool 	-g ${filename} \
		-s bgenfiles/data.sample \
		-incl-rsids ${snplistfile} \
		-og ${outfile}_${i}_gen.gen \
		-os ${outfile}_${i}_gen.sample 
done 

# concatenate .gen files
cat output/EA_snps_*.gen > output/EA_snps_all_gen.gen 
wc -l output/EA_snps_all_gen.gen

# make .sample file with same name
cp output/EA_snps_01_gen.sample output/EA_snps_all_gen.sample

# generate summary stats
qctool –g output/EA_snps_all_gen.gen –s output/EA_snps_all_gen.sample –snp-stats –osnp output/EA_cohortname_snp_stats.txt

qctool –g output/EA_snps_all_gen.gen –s output/EA_snps_all_gen.sample –sample-stats –osample output/ EA_cohortname_sample_stats.txt

# make plink files (convert to dosage)
qctool	-g output/EA_snps_all_gen.gen \
	-s output/EA_snps_all_gen.sample \
		-ofiletype dosage \
		-omit-chromosome \
		-og output/EA_snps_all.dosage \
		-os output/EA_snps_all.sample 

# check SNP and sample numbers are as expected 
wc -l input/EA_all_rsid_round2.txt
wc -l output/EA_snps_all.dosage [note, this file has a header row]
wc -l output/EA_snps_all.sample

(B)	Use the DosageConvertor from http://genome.sph.umich.edu/wiki/DosageConvertor to extract dosages from the VCF. Example:

DosageConvertor --vcfDose study.chr22.dose.vcf.gz –info study.chr22.info.gz –prefix study.chr22.plink –type plink –format DS

(It may be more efficient to convert only those chromosomes that the requested SNPs in EA_all_MarkerName_round2.txt are on).

Extract the rows containing the variants in EA_all_MarkerName_round2.txt using any program/scripting of your choice. 

Concatenate the dosages of the extracted variants. Your file should look like this, SNP ID in chr:pos, followed by A1 = ALT allele, A2 = REF allele and dosages are counting ALT(A1) alleles for two individuals. The sample order is contained in the .fam file so a header is not necessary.

10:60523	G	T	0.007	0.009
10:60969	A	C	0.009	0.008
10:61020	C	G	0.001	0.001

PLINK’s basic functions do not work well with dosages so we will revert back to qctools to extract relevant summary statistics. 

Using qctools, extract the genotype probabilities from VCFs.

qctool -g study.chr22.dose.vcf.gz -vcf-genotype-field GP -og study.chr22.GP.bgen.gz

Using -excl-samples and -incl-rsids, compute SNP summaries (for all SNPs in the SNP list file) and sample summaries (for the same individuals included in the variance explained computation).

qctool -g study.chr22.GP.bgen.gz -s study.sample -excl-samples study_samples.exclude -incl-rsids EAA_all_MarkerName_VCF.txt -snp-stats output.chr22.txt
 
Finally, concatenate all the SNP summary outputs (from different chr) together and return the files: EA_cohortname_snp_stats.txt & EA_cohortname_sample_stats.txt.



For all variant lists, check imputation scores (for imputed variants) and call rates (for genotyped variants) for your study. Exclude imputed variants if the imputation quality is R2 < 0.4 for minimac/Umich imputation server or imputation INFO < 0.4 for IMPUTE/Sanger imputation server. Exclude genotyped variants if the call rate is < 95%.  In all subsequent analyses, please only include variants that passed imputation quality threshold or call rate threshold, as appropriate. 


2)	Generate scores using Plink
Using the GRS variant files provided, generate GRS for all individuals in the dataset using Plink. The GRS variant file names will end in either ‘_adjBetas’, if data from your cohort was included in the GWAS analysis , or ‘_unadjBetas.txt’ if data from your cohort was not included in the GWAS analysis. 

Continuing from the previous step of extracting dosages, if you started with .bgen (or .gen) format, please follow (A); if you started with .vcf.gz format, please follow (B).  

(A)	First, you will need to slightly modify the format of the .dosage file (see code below). Then make sure you specify the correct format for --dosage (given your input .dosage file) – see https://www.cog-genomics.org/plink/1.9/assoc#dosage for details of how to use the skip0/skip1/skip2 options to tell plink which columns are where in the file and the type of dosage data you have. You will also need to generate a plink format sample file (.fam) from the .sample file created in qctool.  

Example shell script:

# modify .dosage file for plink
# reverse allele columns because the dosage is a count of the second allele (according to qctoolv2 documentation)
awk -F" " 'BEGIN{OFS=FS;}{t=$i;$i=$j;$j=t;}1' i=4 j=5 EA_snps_all.dosage > EA_snps_all_reformated.dosage

# remove header line from .dosage file
# this is necessary because plink expects both the FID and IID to appear in the .dosage file from qctools, but only the IID is present.
tail -n +2 MAGIC_snps_all_reformated.dosage > MAGIC_snps_all_reformated _noheader.dosage

# make .fam file from .sample file – remove both header lines and omit ‘missing’ column
tail -n +3 MAGIC_snps_all.sample | awk '{print $1, $2, $4, $5, $6, $7}' > MAGIC_snps_all.fam

There will be three GRS variant files per trait and ancestry, for example, EAonly_cohort_FGluadjBMI_adjBetas.txt (EA signals only), EAplusTE_cohort_FGluadjBMI_adjBetas.txt (EA signals plus trans-ethnic signals) and completeTEplusEA_cohort_GluadjBMI_adjBetas.txt (all signals from the MANTRA analysis plus EA signals).  You need to run the analysis three times per trait, once with each file.  The variant lists have a header row and contain the following columns: “rsID”, “MarkerName”, “Allele1” (the effect allele), “Allele2”, “Effect” & “StdErr” (the precise column names may vary by cohort but will be in the same order). Remove from the GRS variant file (or .dosage file) any variants that did not pass imputation quality threshold or call rate thresholds in your cohort (see above).

Generate GRS for all individuals in the dataset using Plink’s --score function with the “sum”, “double-dosage” and “include-cnt” (this will tell you how many loci from the input variant list were used in the score generation for each individual) options.  Make sure you check the correct format for the --score variant file and tell Plink to read the variant name, effect allele and effect by specifying the column numbers – see https://www.cog-genomics.org/plink/1.9/score for details.  NOTE: when using the ‘noheader’ option on the --dosage line as here, individuals must be in the same order in the .dosage file as in the .fam file. This should be the case if you have made the .dosage file from the .gen file and the .fam file from the .sample file as described above.

Example shell script:

plink 	--dosage MAGIC_snps_all_reformated_noheader.dosage noheader skip0=1 skip1=1 skip2=0 format=1 \
		--fam MAGIC_snps_all.fam \
		--score EAonly_FGluadjBMI_variant_list.txt 1 3 5 header sum double-dosage include-cnt \
		--out EAonly_cohortname_FGluadjBMI_plink_score 
1 3 5 indicates that the rsid is on column 1, effect allele on column 3, regression coefficients on column 5. 

Please note the code given above is an example and the exact commands may vary depending on the exact format of your genotype files. In particular, please check that the -dosage skip commands are correct (i.e that they point to the correct columns in the dosage file) and that the -score column references are correct.

Please return the .log file generated by plink.

(B)	First, you need to update the .fam to contain a phenotype or make a separate phenotype file. This “phenotype” is needed so that Plink will not automatically prune away samples with no phenotype (it is something related to analysing dosages in PLINK, see https://groups.google.com/forum/#!topic/plink2-users/Z3SGFxkoUXU ) - it does not need to be real phenotypic values. 

There will be three GRS variant files per trait and ancestry, for example, EAonly_cohort_FGluadjBMI_adjBetas.txt (EA signals only), EAplusTE_cohort_FGluadjBMI_adjBetas.txt (EA signals plus trans-ethnic signals) and completeTEplusEA_cohort_GluadjBMI_adjBetas.txt (all signals from the MANTRA analysis plus EA signals).  You need to run the analysis three times per trait, once with each file.  The variant lists have a header row and contain the following columns: “rsID”, “MarkerName”, “Allele1” (the effect allele), “Allele2”, “Effect” & “StdErr” (the precise column names may vary by cohort but will be in the same order).  Update the ‘MarkerNames’ names in these files to remove “:SNP”.  Remove from the GRS variant file any variants that did not pass imputation quality threshold or call rate thresholds in your cohort (see above).  

Generate GRS for all individuals in the dataset using Plink’s --score function with the “sum”, “double-dosage” and “include-cnt” (this will tell you how many loci from the input variant list were used in the score generation for each individual) options.  Make sure you check the correct format for the --score variant file and tell Plink to read the variant name, effect allele and effect by specifying the column numbers – see https://www.cog-genomics.org/plink/1.9/score for details.  

Example shell script:

plink  	--allow-no-sex \
--dosage MAGIC_snps_all_reformated.dosage format=1 noheader \
		--fam MAGIC_snps_all.fam \
		--score EAonly_FGluadjBMI_variant_list.txt 2 3 5 header sum double-dosage include-cnt \
		--out EAonly_cohortname_FGluadjBMI_plink_score 

2 3 5 indicates that the variant name is on column 2, effect allele on column 3, regression coefficients on column 5. 

NOTE: when using the ‘noheader’ option on the --dosage line as here, individuals must be in the same order in the .dosage file as in the .fam file.

Please note the code given above is an example and the exact commands may vary depending on the exact format of your genotype files. In particular, please check that the -dosage commands are correct (i.e that they point to the correct columns in the dosage file) and that the -score column references are correct.

Please return the .log file generated by plink.


3)	Calculate variance explained
Merge each GRS with the phenotype data and fit a linear model in R to calculate the variance explained.  Use raw (untransformed) trait values for fasting glucose, 2-hour glucose and HbA1c. Use log transformed trait values for insulin.  Fit the model with (i) only the GRS; (ii) with the GRS plus covariates to include BMI (except for HbA1c) and relevant study-specific covariates, e.g. age, age2, sex, PCs (if the cohort was included in the GWAS please fit the same model used in that analysis) and (iii) with covariates only.  Return summary output from linear models and partial.R2 output.

Example R script:

# read in scores and phenotype
score.in <- "EAonly_cohortname_FGluadjBMI_adjBetas_plink_score.txt"
pheno.in <- "pheno_ALL.ped”

# read in plink scores
scores <- read.table(score.in, h=T)

# read in phenotypes & covariates
pheno <- read.table(pheno.in, h = T)

# merge scores and phenotypes
pheno$FGluadjBMI_scores <- scores$SCORESUM[match(pheno$ID_1, scores$ID_1)]

# install & load library to allow model comparison
install.packages(“asbio”)
library("asbio")

# fit linear model with only GRS
lm.grs <- lm(pheno$FGlu ~ pheno$SCORESUM)
summary(lm.grs)

# fit linear model with covariates (as fitted in GWAS) and GRS
lm.with <- lm(pheno$FGlu ~ pheno$SCORESUM + pheno$age + pheno$agesquared + pheno$sex + pheno$BMI)
summary(lm.with)

# fit linear model with covariates (as fitted in GWAS) but no GRS
lm.without <- lm(pheno$FGlu ~ pheno$age + pheno$agesquared + pheno$sex + pheno$BMI)
summary(lm.without)

# calculate variance explained by GRS as a proportion of variance remaining after covariates fitted
partial.R2(lm.without, lm.with)

Please return a log file containing the printed output from the R script (e.g. R CMD BATCH variance_explained.R will generate a .Rout containing all the results printed to screen) and complete the VarianceExplainedResults.xlsx spreadsheet for your cohort(s).

To be returned:
1.	VarianceExplainedResults.xlsx spreadsheet with a single worksheet completed for each cohort(s) – three results per trait (ancestry-only, ancestry-only plus transethnic and all signals from the MANTRA analysis)
2.	Log file containing the printed output from the R script
3.	SNP summary file for all SNPs in the SNP list file (EA_all_MarkerName_round2.txt /. EA_all_rsid_round2.txt)
4.	Sample summary file for all individuals in the variance explained analysis
5.	Plink log files from GRS generation
